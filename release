#!/bin/bash 
# $Id$

version=0.8.9
WEB="iris.unipress.waw.pl:/d2/people/wojdyr/www/fityk2/"
SF_NEW_RELEASE="https://sourceforge.net/project/admin/newrelease.php?package_id=80864&group_id=79434"

MINGW_DIR=cross_win32
ALL_WIN_FILES=all_files #inside of $MINGW_DIR

win_setup_filename=cross_win32/all_files/Output/fityk-$version-setup.exe
tarball_filename=fityk-$version.tar.bz2

if [ $# -eq 0 ]; then 
 echo Version in this script is set to $version
 echo usage: $0 step_nr
 echo steps:
 echo 0. prepare new version and increase version number 
 echo 1. test if everything compiles after distclean, run samples
 echo 2. test if svn can be compiled with other settings
 echo 3. make tarball
 echo 4. compile windows version and make installer
 echo 5. https://build.opensuse.org/project/show?project=home%3Awojdyr
 echo 8. SourceForge release
 echo 9. put docs on www
 echo 10. announce: freshmeat.net gnomefiles.com
 exit
fi

echo
echo        Step $1 of the release procedure...         
echo
echo -n '===>' 



if [ $1 -eq 0 ]; then
 echo increase version number in configure.ac
 echo "please do it!  See the line with AC_INIT(fityk, x.y.z)"
 echo "and the line with version=x.x.x in this release script"
 echo
 echo now the version in this script is: $version
 echo and configure.ac contains:
 grep AC_INIT configure.ac
 echo and doc/conf.py:
 grep 'version =' doc/conf.py
 echo
 echo svnversion: `svnversion`
 echo Do not forget to update NEWS and doc/index.rst



elif [ $1 -eq 1 ]; then
 echo  testing compilation and instalation after make distclean

 ./autogen.sh
 make distclean
 BUILD_DIR=test1
 rm -rf $BUILD_DIR
 mkdir $BUILD_DIR
 cd $BUILD_DIR
 ../configure --prefix=$HOME/local --enable-python --with-xylib --with-samples
 make 
 make install
 echo run samples...
 cd ../samples
 cfityk nacl01.fit 
 cfityk test_syntax.fit 
 fityk nacl01.fit
 fityk SiC_Zn.fit


elif [ $1 -eq 2 ]; then
 echo  go to buildtest/ and run tests ...
 
elif [ $1 -eq 3 ]; then
 echo  make tarball
 rm -rf xylib/aclocal.m4 xylib/autom4te.cache/ xylib/config.* xylib/configure \
       xylib/depcomp xylib/install-sh xylib/libtool xylib/ltmain.sh \
       xylib/missing xylib/stamp-h1
 ./autogen.sh --prefix=$HOME/local --enable-python --with-xylib --with-samples
 make dist-bzip2

# TODO: testing mac compilation
 
elif [ $1 -eq 4 ]; then
 echo Building MS Windows version
 #WXMSWINSTALL=/home/wojdyr/local/mingw32msvc/
 WXMSWINSTALL=/home/wojdyr/local/mingw32/
 PATH=$PATH:$HOME/local/mingw32/bin
 #
 # wxWidgets where cross-compiled using debian mingw32* packages:
 #      download wxAll
 #      tar xjf ../tarballs/wxWidgets-2.6.2.tar.bz2
 #      cd wxWidgets-2.6.2/
 #      mkdir build-mingw
 #      cd build-mingw/
 #      ../configure --build=i686-pc-linux-gnu --host=i586-mingw32msvc \
 #        --with-msw --disable-threads --disable-shared --disable-unicode \
 #        --enable-optimise --prefix=$WXMSWINSTALL \
 #        --disable-compat26 \
 #        --without-regex --without-expat --without-odbc \
 #        --without-opengl --without-libjpeg --without-libtiff \
 #        --disable-html --disable-htmlhelp --disable-stc --disable-intl \
 #        --disable-protocols --disable-protocol --disable-fs_inet \
 #        --disable-sockets --disable-ipc --disable-apple_ieee \
 #        --disable-backtrace \
 #        --disable-debugreport --disable-dialupman  --disable-tarstream \
 #        --disable-sound --disable-mediactrl --disable-url --disable-variant \
 #        --disable-aui --disable-xrc --disable-docview \
 #        --disable-logdialog --disable-animatectrl --disable-calendar \
 #        --disable-datepick --disable-tipwindow --disable-popupwin \
 #        --disable-splash --disable-tipdlg \
 #        --disable-wizarddlg  --disable-miniframe --disable-joystick \
 #        --disable-gif  --disable-pcx --disable-tga --disable-iff \
 #        --disable-pnm --disable-mdi --disable-richtext
 #      make; make install
 #
 rm -rf $MINGW_DIR
 mkdir $MINGW_DIR
 cd $MINGW_DIR
 tar xjf ../$tarball_filename
 SRC_DIR=fityk-$version
 # host: MinGW from .deb: i586-mingw32msvc, built locally: i586-pc-mingw32
 $SRC_DIR/configure --build=x86_64-pc-linux-gnu --host=i586-pc-mingw32 \
   CXXFLAGS="-O3" LDFLAGS="-s" --disable-CLI --with-wx-prefix=$WXMSWINSTALL \
   --with-xylib

 make || exit
 mkdir -p $ALL_WIN_FILES/samples $ALL_WIN_FILES/src
 cp fityk.iss $SRC_DIR/fityk.url $SRC_DIR/COPYING $SRC_DIR/TODO \
    $SRC_DIR/NEWS $ALL_WIN_FILES
 cp -r doc/html/ $ALL_WIN_FILES/
 cp $SRC_DIR/samples/*.fit $SRC_DIR/samples/*.dat $ALL_WIN_FILES/samples/

 #cp src/wxgui/fityk.exe $ALL_WIN_FILES/src/
 # due to unsolved problem, perhaps in libtool, making executables gives:
 #../../libtool: line 8376: $func_ltwrapper_scriptname_result: ambiguous redirect
 # and we take the executable from .libs/ 
 #cp src/wxgui/fityk.exe $ALL_WIN_FILES/src/
 cp src/wxgui/.libs/fityk.exe $ALL_WIN_FILES/src/

 #echo '"C:\Program Files\HTML Help Workshop\hhc.exe" doc\htmlhelp.hhp' \
 #       				    >$ALL_WIN_FILES/build_help.cmd
 #echo 'ren doc\htmlhelp.chm fitykhelp.chm' >>$ALL_WIN_FILES/build_help.cmd
 echo everything is in: `pwd`/$ALL_WIN_FILES
 

elif [ $1 -eq 8 ]; then
 echo  SF release
 echo uploading files...
 [ ! -e $tarball_filename ] && echo "File not found: $tarball_filename" && exit
 [ ! -e $win_setup_filename ] && echo "File not found: $win_setup_filename" \
                                                                       && exit
 scp $tarball_filename $win_setup_filename frs.sourceforge.net:uploads/
 echo now go to:
 echo $SF_NEW_RELEASE
 echo and add release named: $version
 

elif [ $1 -eq 9 ]; then
 echo  putting docs on www   
 echo destination: $WEB
 cd doc/ 
 make all pdf
 echo "sending PDF manual..."
 scp latex/fityk-manual.pdf $WEB/
 echo sending html
 scp -r html/* $WEB/
 echo generating doxygen docs...
 cd ../doxygen/
 doxygen
 echo sending doxygen docs... 
 scp -r html/ $WEB/doxygen/
 cd ..
 

elif [ $1 -eq 10 ]; then
 echo announce: freshmeat.net gnomefiles.com
 # TODO: freshmeat-submit
 
else
 echo unexpected step number: $1
fi

